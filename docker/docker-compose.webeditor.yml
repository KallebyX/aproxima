version: '3.8'

services:
  aproxima:
    image: node:18-alpine
    container_name: aproxima
    restart: unless-stopped
    network_mode: host
    working_dir: /app
    environment:
      - NODE_ENV=production
      - HOSTNAME=0.0.0.0
      - PORT=3010
    command: >
      sh -c "
        echo 'ðŸš€ Clonando repositÃ³rio...' &&
        apk add --no-cache git &&
        cd /tmp &&
        rm -rf aproxima 2>/dev/null || true &&
        git clone https://github.com/KallebyX/aproxima.git &&
        cd aproxima &&
        echo 'ðŸ“¦ Instalando dependÃªncias...' &&
        npm ci --include=dev --ignore-scripts &&
        echo 'ðŸ”¨ Fazendo build...' &&
        npm run build &&
        echo 'âœ… Iniciando aplicaÃ§Ã£o na porta 3010...' &&
        cd /tmp/aproxima &&
        PORT=3010 node .next/standalone/server.js
      "
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:3010/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
