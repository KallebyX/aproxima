version: '3.8'

services:
  aproxima:
    image: node:18-alpine
    container_name: aproxima
    ports:
      - "3010:3010" # Mapeia a porta 3010 do host para a porta 3010 do container
    environment:
      NODE_ENV: production
      PORT: 3010
    volumes:
      - app_data:/tmp/aproxima # Persiste o cÃ³digo clonado
    command: >
      sh -c "
        apk add --no-cache git &&
        if [ ! -d /tmp/aproxima/.git ]; then
          echo 'ðŸ“¥ Clonando repositÃ³rio...' &&
          git clone https://github.com/KallebyX/aproxima.git /tmp/aproxima &&
          cd /tmp/aproxima &&
          npm ci --include=dev --ignore-scripts &&
          npm run build;
        else
          echo 'âœ… RepositÃ³rio jÃ¡ existe, atualizando...' &&
          cd /tmp/aproxima &&
          git pull;
        fi &&
        echo 'ï¿½ Preparando arquivos...' &&
        cd /tmp/aproxima &&
        cp -r public .next/standalone/ &&
        mkdir -p .next/standalone/.next &&
        cp -r .next/static .next/standalone/.next/ &&
        echo 'ðŸš€ Iniciando aplicaÃ§Ã£o na porta 3010...' &&
        cd .next/standalone &&
        HOSTNAME=0.0.0.0 PORT=3010 node server.js
      "
    restart: unless-stopped # Reinicia o container se ele parar

volumes:
  app_data: # Define o volume para persistir o cÃ³digo
