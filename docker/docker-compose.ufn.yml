version: '3.8'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Stack: aproxima - Plataforma de AproximaÃ§Ã£o AcadÃªmica UFN
# Ambiente: ProduÃ§Ã£o UFN (app.ufn.edu.br)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 
# MÃ‰TODO: Web Editor com clone em runtime
# MOTIVO: Portainer BuildKit tem problemas com build direto do GitHub
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

services:
  app:
    image: node:18-alpine
    container_name: aproxima-app
    restart: always
    
    ports:
      - "${PORT:-3000}:3000"
      # Porta externa configurÃ¡vel via .env (padrÃ£o: 3000)
    
    extra_hosts:
      - "${SITE_URL:-aproxima.app.ufn.edu.br}:${PROXY_IP:-10.21.19.45}"
      # Permite que o container resolva o domÃ­nio pÃºblico internamente
    
    environment:
      - TZ=America/Sao_Paulo
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
      - PORT=3000
      - HOSTNAME=0.0.0.0
      # URL base da aplicaÃ§Ã£o (importante para Next.js)
      - NEXTAUTH_URL=https://${SITE_URL:-aproxima.app.ufn.edu.br}
      - NEXT_PUBLIC_SITE_URL=https://${SITE_URL:-aproxima.app.ufn.edu.br}
      # Adicione outras variÃ¡veis conforme necessÃ¡rio:
      # - DATABASE_URL=${DATABASE_URL}
      # - API_SECRET=${API_SECRET}
    
    volumes:
      - aproxima-data:/tmp/aproxima
      # Volume para persistir cÃ³digo clonado e evitar re-clone a cada restart
    
    command: >
      sh -c "
        echo 'ğŸš€ [APROXIMA UFN] Iniciando deploy...' &&
        apk add --no-cache git wget &&
        if [ ! -d /tmp/aproxima/.git ]; then
          echo 'ğŸ“¥ Clonando repositÃ³rio do GitHub...' &&
          git clone https://github.com/KallebyX/aproxima.git /tmp/aproxima &&
          cd /tmp/aproxima &&
          echo 'ğŸ“¦ Instalando dependÃªncias...' &&
          npm ci --include=dev --ignore-scripts &&
          echo 'ğŸ”¨ Fazendo build da aplicaÃ§Ã£o...' &&
          npm run build &&
          echo 'ğŸ“ Copiando arquivos estÃ¡ticos...' &&
          cp -r public .next/standalone/ &&
          mkdir -p .next/standalone/.next &&
          cp -r .next/static .next/standalone/.next/;
        else
          echo 'âœ… RepositÃ³rio jÃ¡ existe, atualizando...' &&
          cd /tmp/aproxima &&
          git pull &&
          echo 'ğŸ“¦ Atualizando dependÃªncias...' &&
          npm ci --include=dev --ignore-scripts &&
          echo 'ğŸ”¨ Reconstruindo aplicaÃ§Ã£o...' &&
          npm run build &&
          echo 'ğŸ“ Atualizando arquivos estÃ¡ticos...' &&
          cp -r public .next/standalone/ &&
          mkdir -p .next/standalone/.next &&
          cp -r .next/static .next/standalone/.next/;
        fi &&
        echo 'ğŸŒ Iniciando servidor Next.js na porta 3000...' &&
        cd /tmp/aproxima/.next/standalone &&
        HOSTNAME=0.0.0.0 PORT=3000 node server.js
      "
    
    networks:
      - aproxima-network
    
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
      # start_period aumentado para 60s devido ao tempo de clone+build inicial

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# VOLUMES PERSISTENTES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
volumes:
  aproxima-data:
    # Persiste o cÃ³digo clonado entre restarts do container
    # Para forÃ§ar re-clone: delete o volume no Portainer

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# REDE ISOLADA
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
networks:
  aproxima-network:
    name: ${WP_NAME:-aproxima}_net
    driver: bridge
